\documentclass[twocolumn]{article}

% Set for specific document
\def\DOCTITLE{CSC3121 Coursework 2: Total Order Design}
\def\DOCAUTHOR{Dan Nixon (102063697)}
\def\DOCDATE{\today}

% Set document attributes
\title{\DOCTITLE}
\author{\DOCAUTHOR}
\date{\DOCDATE}

\usepackage{fullpage}
\usepackage{scrextend}
\usepackage{titlesec}
\usepackage{fancyhdr}
\usepackage[section]{placeins}

% Handle graphics correctly
\ifx\pdftexversion\undefined
\usepackage{graphicx}
% \usepackage[dvips]{graphicx}
\else
\usepackage[pdftex]{graphicx}
\DeclareGraphicsRule{*}{mps}{*}{}
\fi

% Setup headers and footers
\pagestyle{fancy}
\lhead{}
\chead{\DOCTITLE}
\rhead{}
\rfoot{\DOCDATE}
\cfoot{\thepage}
\lfoot{\DOCAUTHOR}

% New page for each section
% \newcommand{\sectionbreak}{\clearpage}

% Set header and footer sizes
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}
\setlength{\headheight}{15.2pt}
\setlength{\headsep}{15.2pt}

\begin{document}

\section{Design}
\label{sec:design}

The design used for the system is an adaptation of the total order example given
in the lecture notes, an example of a complete message transmit and receive
operation is shown in section \ref{sec:example}.

The following shorthand will be used in the descriptions:

\begin{description}
  \item[$<-$] \hfill \\
    A message sent from this process
  \item[$->$] \hfill \\
    A message received by this process
  \item[$M(t)(r)(i,j)$] \hfill \\
    Message requesting the transmission of of a message from process $i$ to
    process $j$.
  \item[$M(t)(ar)(i)$] \hfill \\
    Message acknowledging that process $i$ has received the request for
    transmission.
  \item[$M(t)(p)(i,j)$] \hfill \\
    Message containing message payload from process $i$ to process $j$.
  \item[$M(t)(ap)(i,j)$] \hfill \\
    Message acknowledging that process $j$ has completed receiving the message
    payload from process $i$.
\end{description}

In all messages $t$ denotes the timestamp given to the message by the local
logical clock of the transmitting process.

In all cases when a message is received with a timestamp $t$ that is greater
then the local logical clock of process $P_{i}$, the clock of $P_{i}$ is set to
$t + 1$.

Unless otherwise states all logical clocks have the initial value of 0 and
increment by 1 per operation.

\subsection{Message sending}
\label{sec:sending}

When a process wants to send a message to any number of other processes it first
sends a request message to every process (broadcast message) in the system (and
keeps a copy  in the local message queue), the payload of which contains the ID
of the process that wants to transmit and a list of the processes that will
receive the message.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.15\textwidth]{out/sending_1.1}
  \caption{Process sends transmission request messages}
  \label{fig:sending_1}
\end{figure}
\FloatBarrier

The process then waits for a response from all other processes which
acknowledges the request, acknowledgement messages are added to the sending
process local message queue as they are received.

All acknowledgements received must have a timestamp greater than that of the
request message.

Once all acknowledgements have arrived the process will then send a message
containing the intended payload to all processes the payload is to be delivered
to.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.15\textwidth]{out/sending_2.1}
  \caption{Process receives acknowledgements and sends payload}
  \label{fig:sending_2}
\end{figure}
\FloatBarrier

The process then waits again for each recipient process to acknowledge the
message being received, once all acknowledgements have been received the sending
process knows that the messages have been delivered successfully to all
recipient processes and removes all messages from its message queue.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.15\textwidth]{out/sending_3.1}
  \caption{Process receives payload acknowledgements and clears local message
           queue}
  \label{fig:sending_3}
\end{figure}
\FloatBarrier

\subsection{Message receiving}
\label{sec:receiving}

When a process receives a message transmission request  the message is added
to the process local message queue and an acknowledgement message sent to the
process that sent to request.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.15\textwidth]{out/receiving_1.1}
  \caption{Received request message and sent acknowledgement}
  \label{fig:receiving_1}
\end{figure}
\FloatBarrier

The process then waits for further messages, in the case where this process is a
recipient of the message then the next expected message is the payload,
otherwise the next message(s) should be payload acknowledgements for each of the
recipients.

For this example the process is a recipient.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.15\textwidth]{out/receiving_2.1}
  \caption{Receiving the message payload}
  \label{fig:receiving_2}
\end{figure}
\FloatBarrier

Once the payload has been received the payload acknowledgement message will be
sent to all processes, if this process was the only recipient then the receiving
is complete and the local process queue can be cleared and the message payload
passed from the total order instance to the process.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.15\textwidth]{out/receiving_3.1}
  \caption{Sending the message payload acknowledgement}
  \label{fig:receiving_3}
\end{figure}
\FloatBarrier

If there are multiple recipients then this process will wait until it received
a payload acknowledgement from every other recipient listed in the initial
request message, once all acknowledgements have been received then the
transmission will be considered successful and the local message queue cleared
and the message payload passed from the total order instance to the process.

A message receiving operation is complete from the point of view of a receiving
process when it has sent its payload acknowledgement and in the case of multiple
recipients, it has received the payload acknowledgements from every other
recipient.

Note that the transmission of the final payload acknowledgement message ensures
that the logical clocks of all processes in the system are synchronised, as the
final acknowledgement message will always have the largest timestamp assuming
all total order instances respect rules 1 and two listed in section
\ref{sec:delivery}.

\subsection{Message delivery}
\label{sec:delivery}

Message delivery is assured through the following rules that each total order
instance must abide by:

\begin{enumerate}
  \item[1]
    Once a process receives a message transmission request it may not
    attempt to transmit a message until all payload acknowledgement messages have
    been received.
  \item[2]
    A sending process must not transmit the payload until all transmission
    request acknowledgement messages have been received.
  \item[3]
    Should a process receive multiple request messages it must acknowledge the
    message with the lowest timestamp first (keeping the other messages in the
    message queue).
    If the timestamps are identical then priority is given to messages sent by
    processes with a lower process number.
\end{enumerate}

Together, these rules ensure that both conditions hold by ensuring that delivery
of identical messages (messages with the same payload, sent from a single
process and received by multiple processes in the system) happen simultaneously
(by logical clock time) while delivery of distinct messages (messages sent at
different logical clock times) can never happen happen either at the same time
or out of the transmission order (i.e. they cannot break the happened before
relation).

A message delivery is complete from the point of view of a process that is not
directly involved in the transmission (i.e. not the sender nor a recipient) when
a payload acknowledgement message is received from every recipient that was
listed in the original message transfer request.

\subsection{Example}
\label{sec:example}

The following figures show an example of a single message transmission from $P1$
to $P3$.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/example_1.1}
  \caption{Message transmission request and acknowledgement}
  \label{fig:example_1}
\end{figure}
\FloatBarrier

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/example_2.1}
  \caption{Message payload transmission}
  \label{fig:example_2}
\end{figure}
\FloatBarrier

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/example_3.1}
  \caption{Message payload acknowledgement}
  \label{fig:example_3}
\end{figure}
\FloatBarrier

\section{Correctness}
\label{sec:correctness}

This section aims to prove the correctness of the design described in section
\ref{sec:design} through the use of examples covering several scenarios the
system may be subjected to.

\subsection{Multiple messages to one recipient}

This example demonstrates the case where two messages are sent to a single
recipient where the two sending processes have different local logical times.

In this case the message $m_{1}$ sent from process $P1$ to $P3$ and the message
$m_{2}$ from $P4$ to $P3$ have the happened before relation: $m_{1} \Rightarrow
m_{2}$.

This demonstrates the correct operation of the priority negotiation logic in
cases where the messages arrive at processes out of their priority order. This
is shown in figure \ref{fig:multiplemessagesonerecipient_1} where the two
non-sending processes ($P2$ and $P3$) receive the transmission request messages
in a different order and still acknowledge the correct message.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/multiplemessagesonerecipient_1.1}
  \caption{Initial requests}
  \label{fig:multiplemessagesonerecipient_1}
\end{figure}
\FloatBarrier

When the request messages have been received the first message to be
acknowledged is the request for $P1$ to transmit to $P3$ as $P1$ has a lower
timestamp (1) to $P4$ (5).

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/multiplemessagesonerecipient_2.1}
  \caption{Acknowledgment of $m_{1}$}
  \label{fig:multiplemessagesonerecipient_2}
\end{figure}
\FloatBarrier

Next $P1$ transmits the payload to $P3$ and when it is received $P3$ sends the
acknowledge message to all processes.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/multiplemessagesonerecipient_3.1}
  \caption{Transmission and acknowledgement of $m_{1}$ payload}
  \label{fig:multiplemessagesonerecipient_3}
\end{figure}
\FloatBarrier

Note that process $P3$ received the payload of message $m_{1}$ at local logical
time 5.

When the payload acknowledgement is received all process clear their local
message queues of the request and acknowledge messages relating to the completed
request.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/multiplemessagesonerecipient_4.1}
  \caption{Clear local message queues}
  \label{fig:multiplemessagesonerecipient_4}
\end{figure}
\FloatBarrier

The total order instance of $P3$ then sends the message to the process and
removes the payload message from the local message queue.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/multiplemessagesonerecipient_5.1}
  \caption{Acknowledge $m_{2}$ request}
  \label{fig:multiplemessagesonerecipient_5}
\end{figure}
\FloatBarrier

Next the acknowledgement process begins again for the transmission request
from process $P4$ to $P3$ and after receiving all request acknowledgements $P4$
transmits the payload message to $P3$.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/multiplemessagesonerecipient_6.1}
  \caption{Transmit $m_{2}$ payload}
  \label{fig:multiplemessagesonerecipient_6}
\end{figure}
\FloatBarrier

Note that process $P3$ received the payload of message $m_{2}$ at local logical
time 11.

Once the message is received the payload acknowledgement messages are sent to
all processes by $P3$.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]{out/multiplemessagesonerecipient_7.1}
  \caption{Acknowledge $m_{2}$ payload}
  \label{fig:multiplemessagesonerecipient_7}
\end{figure}
\FloatBarrier

At this point the local message queues are cleared, the payload delivered to
process $P3$ by the total order instance and all processes in the system will
contain empty message queues.

As the timestamp of the delivery of message $m_{1}$ (5) is less than the
timestamp of delivery of $m_{2}$ (11), the delivery of the two messages
maintains the happened before relation of their transmission, therefore the
system fulfils condition 1.

\subsection{Multiple messages to multiple recipients}

In this example multiple messages are sent to a common subset of recipients at
the same logical clock time, in this case the order of message delivery is not
guaranteed as this depends on the sending processes (specifically their process
IDs), however in order to meet condition 2 the order of delivery must be common
between all recipients.

Here four messages will be sent: $P1$ will send message $m_{1}$ to processes
$P2$ and $P3$, $P4$ will send message $m_{2}$ to the same recipients.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]
                  {out/multiplemessagesmultiplerecipients_1.1}
  \caption{Initial requests}
  \label{fig:multiplemessagesmultiplerecipients_1}
\end{figure}
\FloatBarrier

Since both message transmission requests have the same timestamp priority is
given to process $P1$ due to its lower process ID. Therefore the request to
transmit $m_{1}$ is acknowledged first.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]
                  {out/multiplemessagesmultiplerecipients_2.1}
  \caption{$m_{1}$ transmission request acknowledgements}
  \label{fig:multiplemessagesmultiplerecipients_2}
\end{figure}
\FloatBarrier

Once the transmission request acknowledgements have been received the payload of
message $m_{1}$ is sent to $P2$ and $P3$ and acknowledged by both recipient
processes.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]
                  {out/multiplemessagesmultiplerecipients_3.1}
  \caption{Transmission and acknowledgement of $m_{1}$ payload}
  \label{fig:multiplemessagesmultiplerecipients_3}
\end{figure}
\FloatBarrier

At this point the payload of $m_{1}$ is delivered to both recipient processes
by the total order instance and the message queues clears of messages relating
to $m_{1}$ leaving the transmission requests for $m_{2}$.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]
                  {out/multiplemessagesmultiplerecipients_4.1}
  \caption{Delivery of $m_{1}$ complete}
  \label{fig:multiplemessagesmultiplerecipients_4}
\end{figure}
\FloatBarrier

As it is now the only transmission request message in the local message queues
the acknowledgement for $m_{2}$ is sent by all processes (except the sending
process, $P4$).

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]
                  {out/multiplemessagesmultiplerecipients_5.1}
  \caption{$m_{2}$ transmission request acknowledgements}
  \label{fig:multiplemessagesmultiplerecipients_5}
\end{figure}
\FloatBarrier

Once the transmission request acknowledgements have been received the payload of
message $m_{2}$ is sent and the recipient processes then send the payload
acknowledgement messages to all processes in the system.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.5\textwidth]
                  {out/multiplemessagesmultiplerecipients_6.1}
  \caption{Transmission and acknowledgement of $m_{2}$ payload}
  \label{fig:multiplemessagesmultiplerecipients_6}
\end{figure}
\FloatBarrier

Finally the message payload is delivered to the recipient process by the total
order instances and the message queues are cleared of messages relating to
$m_{2}$ leaving an empty queue on each process in the system.

This example demonstrates how only one unique message may ever be delivered
simultaneously, this is guaranteed by rules 1 and 2 described in section
\ref{sec:delivery} which ensure that processes cannot send any message payloads
until they have received all required acknowledgements from every other process
in the system.

\end{document}
